# 校庆换头像小程序复盘

## 项目相关问题总结 

---

####  1.时间紧&项目排期松散

本次项目从时间上看，从接到项目到上线只有10天，从设计搞出来到上线只有5天。

时间太紧导致后面没有足够的时间测试，正式上线出现bug已难以修改。

此外项目排期松散，没有明确的排期表，各阶段没有明确的时间点，只有一个固定的DDL，都导致项目可控性差。存在很大延期风险（虽然最后赶在DDL之前上线了）。

针对以上问题的建议：

1. 尽早启动
2. 除了关注需求，也需要对整个项目进行管理，需求出来后，除了开会商讨需求可行性，也要明确每个同学的责任，要**了解每个同学完成自己部分的任务预计时间**，然后以此**制定项目排期时间表**。

#### 2.团队文档/设计稿

团队交流及文档全在微信群里，有时候消息多很容易就把文件刷过去了，此外某个文档更新后也容易弄混。

**建议** 使用微信群交流，然后文档/设计稿使用团队开发协同平台存放（如：蓝湖），使用协同开发平台的好处是文档只需要维护最新版，然后有问题的地方进行在线标注后大家立马就能看到。对于设计稿，不再是一个个独立的psd文件，不同页面用线条连接起来，流程一目了然，更方便梳理页面逻辑。

## 技术相关问题总结 & 技术难点回顾

---

#### 1.项目代码缺少注释，代码风格不一，历史包袱重

代码注释少，代码分格有好几种，也有大段未删除的无用代码

对项目中遗留的无用代码，我在开发过程中删除了一部分，由于时间原因，代码仍然存在很大优化空间，这部分任务可以给以后入小招的开发同学作为练手。

**建议**统一开发规范，留给以后同学一份[小程序开发规范参考](https://ld246.com/article/1539740402824)

#### 2. 资源存放

使用云开发，在数据库中创建了两个集合，data和message，data集合用来记录用户编号，用以生成明信片邮编。message集合用来记录用户在树洞提交内容。

查看方式，通过微信开发者工具打开项目 --> 云开发 --> 数据库 即可查看。

#### 3.难点 & 踩坑回顾

1. 小程序数据绑定 用双花括号{{message}} 

   当数据要放到组件的属性中时，需要在**双引号**之内（单引号不可以）

2. 小程序很多方法都是异步的，然后绘制的时候图片又要按序绘制，所以要非常注意顺序，

   坑：图片导出后发现有些图片没有绘制上去，甚至直接就啥也没有

3. 调用canvas的drawImage时使用本地tmp路径的临时文件报错，

   ![image-20211017155754108](https://s2.loli.net/2022/01/03/lIRH1nDTbNK4w5E.png)

   **原因：**开了http代理（挂了梯子）

   **解决：**在IDE中，把代理设置成：不适用任何代理。（默认是系统代理）

4. CanvasContext.drawImage(string imageResource, number sx, number sy, number sWidth, number sHeight, number dx, number dy, number dWidth, number dHeight)

   该方法中，图片资源如果是网络图片，要先通过 getImageInfo / downloadFile 方法下载，下载前需要先配置小程序的downloadFile合法域名。

   getImageInfo为异步方法，所以应该在其成功回调中拿取图片资源

5. 怎样给头像加头像框？

   在同一张canvas上绘制两次

   第一次 把头像画上去

   第二次 把头像框画上去

6. iPhone12及以后机型不能正常显示明信片（补充描述：部分ios系统生成图片失败）==尚未解决的问题==

   具体表现为真机上保存的明信片是空白。

   有两种可能，

   第一种是canvas绘制时还没绘制好就保存了，

   第二种是保存canvas使用wx.canvasToTempFilePath 方法生成图片失败

   经定位问题应该是第二种，在微信开发者社区找到同样问题：

   https://developers.weixin.qq.com/community/develop/doc/0004acc5878cf8bb1b6cbdf3356c00

   以上链接中所给解决方案为（**实测后该方案无效**）：隐藏canvas场景，建议使用 position: fixed;

   测试场景：

   "display: none;"：ios 接口报错，模拟器和安卓正常；隐藏正常

   "visibility: hidden;"：接口正常；模拟器和 ios 不隐藏，安卓隐藏

   "position: fixed;"：接口正常；隐藏正常

   "overflow:hidden;"：接口正常；模拟器不隐藏，ios和安卓隐藏

   "不隐藏"：接口正常

   

   由于上面方案无效，遂转变思路：

    由于我们的明信片宽高较大，所以使用wx.canvasToTempFilePath方法来保存高清图片可能存在生成图片失败问题，据此找到一下解决方案来保存图片：https://segmentfault.com/a/1190000025170400

   该方案由于时间原因，目前尚未尝试（留给学弟练手（逃~

   

最后，留下项目的GitHub地址：https://github.com/Llldmiao/headingImage



